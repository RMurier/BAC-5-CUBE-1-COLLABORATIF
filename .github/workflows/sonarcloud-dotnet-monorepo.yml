name: SonarCloud (.NET monorepo)

on:
  push:
    branches: [ "master" ]
  pull_request:

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: auth
            workdir: goodfood-ms-auth
            project_key: goodfood_auth
            project_name: GoodFood.Auth
            token_secret: SONAR_TOKEN_AUTH

          - name: commandes
            workdir: goodfood-ms-commandes
            project_key: goodfood_commandes
            project_name: GoodFood.Commandes
            token_secret: SONAR_TOKEN_COMMANDES

          - name: tracking
            workdir: goodfood-ms-tracking
            project_key: goodfood_tracking
            project_name: GoodFood.Tracking
            token_secret: SONAR_TOKEN_TRACKING

          - name: sav
            workdir: goodfood-ms-sav
            project_key: goodfood_sav
            project_name: GoodFood.Sav
            token_secret: SONAR_TOKEN_SAV

          - name: notifications
            workdir: goodfood-ms-notifications
            project_key: goodfood_notifications
            project_name: GoodFood.Notifications
            token_secret: SONAR_TOKEN_NOTIFICATIONS

          - name: logs
            workdir: goodfood-ms-logs
            project_key: goodfood_logs
            project_name: GoodFood.Logs
            token_secret: SONAR_TOKEN_LOGS

          - name: stock
            workdir: goodfood-ms-stock
            project_key: goodfood_stock
            project_name: GoodFood.Stock
            token_secret: SONAR_TOKEN_STOCK

          - name: fournisseurs
            workdir: goodfood-ms-fournisseurs
            project_key: goodfood_fournisseurs
            project_name: GoodFood.Fournisseurs
            token_secret: SONAR_TOKEN_FOURNISSEURS

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install dotnet-sonarscanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Analyze (${{ matrix.name }})
        working-directory: ${{ matrix.workdir }}
        env:
          # Token du microservice (si tu l'as créé)
          SONAR_TOKEN_MS: ${{ secrets[matrix.token_secret] }}
          # Token global (fallback)
          SONAR_TOKEN_GLOBAL: ${{ secrets.SONAR_TOKEN }}

          # IMPORTANT: remplace "goodfood" par le nom EXACT de ton organisation SonarCloud
          SONAR_ORG: rmurier

          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          set -e

          # Fallback token
          SONAR_TOKEN="$SONAR_TOKEN_MS"
          if [ -z "$SONAR_TOKEN" ]; then
            SONAR_TOKEN="$SONAR_TOKEN_GLOBAL"
          fi

          if [ -z "$SONAR_TOKEN" ]; then
            echo "Missing SONAR token: define either ${{ matrix.token_secret }} or SONAR_TOKEN"
            exit 1
          fi

          dotnet-sonarscanner begin \
            /k:"${{ matrix.project_key }}" \
            /o:"$SONAR_ORG" \
            /n:"${{ matrix.project_name }}" \
            /d:sonar.host.url="$SONAR_HOST_URL" \
            /d:sonar.token="$SONAR_TOKEN" \
            /d:sonar.scanner.skipJreProvisioning=true

          dotnet restore
          dotnet build -c Release --no-restore

          dotnet-sonarscanner end /d:sonar.token="$SONAR_TOKEN"